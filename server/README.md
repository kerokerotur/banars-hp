# サーバー開発手順

## 実行環境について

`server` ディレクトリのコードは Cloudflare Workers 上で動作することを前提に実装されています。Workers ランタイムでは `URL` や `Response` をはじめとする Web API、さらに `fetch` などのグローバル関数が自動で提供され、`ExportedHandler<Env>` 形式でエントリーポイントをエクスポートします。環境変数やバインディング（D1 データベースなど）は Wrangler が生成する `worker-configuration.d.ts` 内の `Env` インターフェースで型付けされており、`fetch` ハンドラーの第 2 引数から参照します。

ローカル開発時も `pnpm dev` で `wrangler dev` が立ち上がるため、実際の Workers ランタイムと同じグローバル／環境変数の挙動で確認できます。新しい環境変数やバインディングを追加した場合は `pnpm cf-typegen` を実行して `worker-configuration.d.ts` を再生成し、型情報とランタイムの定義を同期させてください。

## ローカル開発

サーバーをローカルで起動する手順:

1. `server`ディレクトリに移動します。
2. 以下のコマンドを実行します:
   ```bash
   pnpm dev
   ```

## デプロイ

サーバーをデプロイする手順:

1. `server`ディレクトリに移動します。
2. 以下のコマンドを実行します:
   ```bash
   pnpm server-deploy
   ```

## データベース定義の変更手順

### マイグレーションファイルの作成

マイグレーションファイルを作成する手順:

1. `server`ディレクトリに移動します。
2. 以下のコマンドを実行します。`{suffix}`は作成するファイルの接尾辞に置き換えてください:
   ```bash
   pnpm mg-create {suffix}
   ```

### ローカルデータベースへのマイグレーション適用

ローカルデータベースにマイグレーションを適用する手順:

1. `server`ディレクトリに移動します。
2. 以下のコマンドを実行します:
   ```bash
   pnpm mg-deploy-local
   ```
